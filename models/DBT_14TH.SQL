{{ config(
    materialized='table',
    alias='CROSS_ITEMS'
) }}

WITH CROSS_ITEMS AS (
    SELECT I_ITEM_SK AS SS_ITEM_SK
    FROM {{ source('SNOWFLAKE_SAMPLE_DATA', 'ITEM') }} ITEM
    JOIN (
        SELECT ISS.I_BRAND_ID AS BRAND_ID,
               ISS.I_CLASS_ID AS CLASS_ID,
               ISS.I_CATEGORY_ID AS CATEGORY_ID
        FROM {{ source('SNOWFLAKE_SAMPLE_DATA', 'STORE_SALES') }} STORE_SALES
        JOIN {{ source('SNOWFLAKE_SAMPLE_DATA', 'ITEM') }} ISS ON STORE_SALES.SS_ITEM_SK = ISS.I_ITEM_SK
        JOIN {{ source('SNOWFLAKE_SAMPLE_DATA', 'DATE_DIM') }} D1 ON STORE_SALES.SS_SOLD_DATE_SK = D1.D_DATE_SK
        WHERE D1.D_YEAR BETWEEN 1999 AND 2001
        INTERSECT
        SELECT ICS.I_BRAND_ID,
               ICS.I_CLASS_ID,
               ICS.I_CATEGORY_ID
        FROM {{ source('SNOWFLAKE_SAMPLE_DATA', 'CATALOG_SALES') }} CATALOG_SALES
        JOIN {{ source('SNOWFLAKE_SAMPLE_DATA', 'ITEM') }} ICS ON CATALOG_SALES.CS_ITEM_SK = ICS.I_ITEM_SK
        JOIN {{ source('SNOWFLAKE_SAMPLE_DATA', 'DATE_DIM') }} D2 ON CATALOG_SALES.CS_SOLD_DATE_SK = D2.D_DATE_SK
        WHERE D2.D_YEAR BETWEEN 1999 AND 2001
        INTERSECT
        SELECT IWS.I_BRAND_ID,
               IWS.I_CLASS_ID,
               IWS.I_CATEGORY_ID
        FROM {{ source('SNOWFLAKE_SAMPLE_DATA', 'WEB_SALES') }} WEB_SALES
        JOIN {{ source('SNOWFLAKE_SAMPLE_DATA', 'ITEM') }} IWS ON WEB_SALES.WS_ITEM_SK = IWS.I_ITEM_SK
        JOIN {{ source('SNOWFLAKE_SAMPLE_DATA', 'DATE_DIM') }} D3 ON WEB_SALES.WS_SOLD_DATE_SK = D3.D_DATE_SK
        WHERE D3.D_YEAR BETWEEN 1999 AND 2001
    ) X
    WHERE X.BRAND_ID = I_BRAND_ID
      AND X.CLASS_ID = I_CLASS_ID
      AND X.CATEGORY_ID = I_CATEGORY_ID
),
AVG_SALES AS (
    SELECT AVG(QUANTITY * LIST_PRICE) AVERAGE_SALES
    FROM (
        SELECT SS_QUANTITY QUANTITY,
               SS_LIST_PRICE LIST_PRICE
        FROM {{ source('SNOWFLAKE_SAMPLE_DATA', 'STORE_SALES') }} STORE_SALES
        JOIN {{ source('SNOWFLAKE_SAMPLE_DATA', 'DATE_DIM') }} D1 ON STORE_SALES.SS_SOLD_DATE_SK = D1.D_DATE_SK
        WHERE D1.D_YEAR BETWEEN 1999 AND 2001
        UNION ALL
        SELECT CS_QUANTITY QUANTITY,
               CS_LIST_PRICE LIST_PRICE
        FROM {{ source('SNOWFLAKE_SAMPLE_DATA', 'CATALOG_SALES') }} CATALOG_SALES
        JOIN {{ source('SNOWFLAKE_SAMPLE_DATA', 'DATE_DIM') }} D2 ON CATALOG_SALES.CS_SOLD_DATE_SK = D2.D_DATE_SK
        WHERE D2.D_YEAR BETWEEN 1999 AND 2001
        UNION ALL
        SELECT WS_QUANTITY QUANTITY,
               WS_LIST_PRICE LIST_PRICE
        FROM {{ source('SNOWFLAKE_SAMPLE_DATA', 'WEB_SALES') }} WEB_SALES
        JOIN {{ source('SNOWFLAKE_SAMPLE_DATA', 'DATE_DIM') }} D3 ON WEB_SALES.WS_SOLD_DATE_SK = D3.D_DATE_SK
        WHERE D3.D_YEAR BETWEEN 1999 AND 2001
    )
)
SELECT THIS_YEAR.CHANNEL TY_CHANNEL,
       THIS_YEAR.I_BRAND_ID TY_BRAND,
       THIS_YEAR.I_CLASS_ID TY_CLASS,
       THIS_YEAR.I_CATEGORY_ID TY_CATEGORY,
       THIS_YEAR.SALES TY_SALES,
       THIS_YEAR.NUMBER_SALES TY_NUMBER_SALES,
       LAST_YEAR.CHANNEL LY_CHANNEL,
       LAST_YEAR.I_BRAND_ID LY_BRAND,
       LAST_YEAR.I_CLASS_ID LY_CLASS,
       LAST_YEAR.I_CATEGORY_ID LY_CATEGORY,
       LAST_YEAR.SALES LY_SALES,
       LAST_YEAR.NUMBER_SALES LY_NUMBER_SALES
FROM (
    SELECT 'store' CHANNEL,
           I_BRAND_ID,
           I_CLASS_ID,
           I_CATEGORY_ID,
           SUM(SS_QUANTITY * SS_LIST_PRICE) SALES,
           COUNT(*) NUMBER_SALES
    FROM {{ source('SNOWFLAKE_SAMPLE_DATA', 'STORE_SALES') }} STORE_SALES
    JOIN {{ source('SNOWFLAKE_SAMPLE_DATA', 'ITEM') }} ITEM ON STORE_SALES.SS_ITEM_SK = ITEM.I_ITEM_SK
    JOIN {{ source('SNOWFLAKE_SAMPLE_DATA', 'DATE_DIM') }} D1 ON STORE_SALES.SS_SOLD_DATE_SK = D1.D_DATE_SK
    WHERE SS_ITEM_SK IN (SELECT SS_ITEM_SK FROM CROSS_ITEMS)
      AND D1.D_WEEK_SEQ = (SELECT D_WEEK_SEQ FROM {{ source('SNOWFLAKE_SAMPLE_DATA', 'DATE_DIM') }} WHERE D_YEAR = 2000 AND D_MOY = 12 AND D_DOM = 11)
    GROUP BY I_BRAND_ID, I_CLASS_ID, I_CATEGORY_ID
    HAVING SUM(SS_QUANTITY * SS_LIST_PRICE) > (SELECT AVERAGE_SALES FROM AVG_SALES)
) THIS_YEAR
JOIN (
    SELECT 'store' CHANNEL,
           I_BRAND_ID,
           I_CLASS_ID,
           I_CATEGORY_ID,
           SUM(SS_QUANTITY * SS_LIST_PRICE) SALES,
           COUNT(*) NUMBER_SALES
    FROM {{ source('SNOWFLAKE_SAMPLE_DATA', 'STORE_SALES') }} STORE_SALES
    JOIN {{ source('SNOWFLAKE_SAMPLE_DATA', 'ITEM') }} ITEM ON STORE_SALES.SS_ITEM_SK = ITEM.I_ITEM_SK
    JOIN {{ source('SNOWFLAKE_SAMPLE_DATA', 'DATE_DIM') }} D2 ON STORE_SALES.SS_SOLD_DATE_SK = D2.D_DATE_SK
    WHERE SS_ITEM_SK IN (SELECT SS_ITEM_SK FROM CROSS_ITEMS)
      AND D2.D_WEEK_SEQ = (SELECT D_WEEK_SEQ FROM {{ source('SNOWFLAKE_SAMPLE_DATA', 'DATE_DIM') }} WHERE D_YEAR = 1999 AND D_MOY = 12 AND D_DOM = 11)
    GROUP BY I_BRAND_ID, I_CLASS_ID, I_CATEGORY_ID
    HAVING SUM(SS_QUANTITY * SS_LIST_PRICE) > (SELECT AVERAGE_SALES FROM AVG_SALES)
) LAST_YEAR
ON THIS_YEAR.I_BRAND_ID = LAST_YEAR.I_BRAND_ID
   AND THIS_YEAR.I_CLASS_ID = LAST_YEAR.I_CLASS_ID
   AND THIS_YEAR.I_CATEGORY_ID = LAST_YEAR.I_CATEGORY_ID
ORDER BY THIS_YEAR.CHANNEL, THIS_YEAR.I_BRAND_ID, THIS_YEAR.I_CLASS_ID, THIS_YEAR.I_CATEGORY_ID
